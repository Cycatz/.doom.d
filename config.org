#+title: literate doom emacs configs


* Default stuff
#+begin_src emacs-lisp
;;; $DOOMDIR/config.el -*- lexical-binding: t; -*-

;; Place your private configuration here! Remember, you do not need to run 'doom
;; sync' after modifying this file!


;; Some functionality uses this to identify you, e.g. GPG configuration, email
;; clients, file templates and snippets. It is optional.
(setq user-full-name "Fan Chung"
      user-mail-address "cycatz@staque.xyz")

;; Doom exposes five (optional) variables for controlling fonts in Doom:
;;
;; - `doom-font' -- the primary font to use
;; - `doom-variable-pitch-font' -- a non-monospace font (where applicable)
;; - `doom-big-font' -- used for `doom-big-font-mode'; use this for
;;   presentations or streaming.
;; - `doom-unicode-font' -- for unicode glyphs
;; - `doom-serif-font' -- for the `fixed-pitch-serif' face
;;
;; See 'C-h v doom-font' for documentation and more examples of what they
;; accept. For example:
;;
;; (setq doom-fon t (font-spec :family "Inconsolata" :size 24 :weight 'Regular :width "condensed")
;;       doom-variable-pitch-font (font-spec :family "Manrope" :weight 'normal :size 20))

;;
;; If you or Emacs can't find your font, use 'M-x describe-font' to look them
;; up, `M-x eval-region' to execute elisp code, and 'M-x doom/reload-font' to
;; refresh your font settings. If Emacs still can't find your font, it likely
;; wasn't installed correctly. Font issues are rarely Doom issues!

;; There are two ways to load a theme. Both assume the theme is installed and
;; available. You can either set `doom-theme' or manually load a theme with the
;; `load-theme' function. This is the default:
(setq doom-theme 'doom-gruvbox)

;; This determines the style of line numbers in effect. If set to `nil', line
;; numbers are disabled. For relative line numbers, set this to `relative'.
(setq display-line-numbers-type t)

;; If you use `org' and don't want your org files in the default location below,
;; change `org-directory'. It must be set before org loads!
(setq org-directory "~/org/")


;; Whenever you reconfigure a package, make sure to wrap your config in an
;; `after!' block, otherwise Doom's defaults may override your settings. E.g.
;;
;;   (after! PACKAGE
;;     (setq x y))
;;
;; The exceptions to this rule:
;;
;;   - Setting file/directory variables (like `org-directory')
;;   - Setting variables which explicitly tell you to set them before their
;;     package is loaded (see 'C-h v VARIABLE' to look up their documentation).
;;   - Setting doom variables (which start with 'doom-' or '+').
;;
;; Here are some additional functions/macros that will help you configure Doom.
;;
;; - `load!' for loading external *.el files relative to this one
;; - `use-package!' for configuring packages
;; - `after!' for running code after a package has loaded
;; - `add-load-path!' for adding directories to the `load-path', relative to
;;   this file. Emacs searches the `load-path' when you load packages with
;;   `require' or `use-package'.
;; - `map!' for binding new keys
;;
;; To get information about any of these functions/macros, move the cursor over
;; the highlighted symbol at press 'K' (non-evil users must press 'C-c c k').
;; This will open documentation for it, including demos of how they are used.
;; Alternatively, use `C-h o' to look up a symbol (functions, variables, faces,
;; etc).
;;
;; You can also try 'gd' (or 'C-c c d') to jump to their definition and see how
;; they are implemented.
#+end_src

* Doom
#+begin_src emacs-lisp
(add-to-list '+lookup-provider-url-alist '("Merriam Webster" "https://www.merriam-webster.com/dictionary/%s"))
#+end_src
* My Configs
** Basic

#+begin_src emacs-lisp
(setq confirm-kill-emacs nil)
#+end_src

*** undo-tree
#+begin_src emacs-lisp
(after! undo-tree
  ;; Enable undo-tree mode
  (global-undo-tree-mode)
  ;; Undo in non-file buffers
  (add-hook 'evil-local-mode-hook 'turn-on-undo-tree-mode)
  (setq undo-tree-auto-save-history t)
  (setq undo-tree-history-directory-alist '(("." . "~/.emacs.d/undo"))))
#+end_src

*** Recentf
#+begin_src emacs-lisp
(after! recentf
  (setq
    recentf-save-file (concat user-emacs-directory "recentf")
    recentf-max-saved-items 10000
    recentf-max-menu-items 5000
    )
  ; Save the file list into recentf every 5 minutes:
  (run-at-time nil (* 5 60) 'recentf-save-list))
#+end_src
*** Backup
#+begin_src emacs-lisp
(defvar --backup-directory (concat (getenv "HOME") "/.emacs.saves"))
(if (not (file-exists-p --backup-directory))
        (make-directory --backup-directory t))
(setq backup-directory-alist `(("." . ,--backup-directory)))    ; don't litter my fs tree
(setq make-backup-files t               ; backup of a file the first time it is saved.
      backup-by-copying t               ; don't clobber symlinks
      version-control t                 ; version numbers for backup files
      delete-old-versions t             ; delete excess backup files silently
      delete-by-moving-to-trash t
      kept-old-versions 6               ; oldest versions to keep when a new numbered backup is made (default: 2)
      kept-new-versions 9               ; newest versions to keep when a new numbered backup is made (default: 2)
      auto-save-default t               ; auto-save every buffer that visits a file
      auto-save-timeout 20              ; number of seconds idle time before auto-save (default: 30)
      auto-save-interval 200            ; number of keystrokes between auto-saves (default: 300)
      )
#+end_src

** Font
 See [[https://emacs-china.org/t/emacs/15676/24?page=2][经验分享：emacs单独设置中文与英语的字体 - Emacs-general - Emacs China ]]for details:


#+begin_src emacs-lisp
;; Setting medium weight for "Inconsolata Semibold" doesn't work, it doesn't exist in the list of `describe-font`.
(setq doom-font "-CYRE-Inconsolata-semibold-normal-semicondensed-*-24-*-*-*-m-0-iso10646-1")
#+end_src

Set CJK fonts after doom sets the font. It shows the emoji correctly.
#+begin_src emacs-lisp
;; The CJK characters will not be scaled when scaling in this approach.
(defun cycatz/set-fonts()
  (set-fontset-font t 'unicode (font-spec :family "蘋方-繁" :size 19) nil 'append))
  (set-fontset-font t 'cjk-misc (font-spec :family "Noto Sans CJKS TC" :size 19) nil 'append)
(add-hook! 'after-setting-font-hook :append 'cycatz/set-fonts)

;; Actually we can append our CJK font into the emoji list, it solves the issue of missing fonts and is able to be scaled.
;; But the default size is too large for me.
;; (add-to-list 'doom-emoji-fallback-font-families "蘋方-繁")
#+end_src

You can call ~describe-fontset~ to see whether ~fontset-default~ is set correctly.
** Yasnippet
#+begin_src emacs-lisp
(after! yasnippet
    (add-to-list 'yas-snippet-dirs (concat (getenv "HOME") "/Code/Snippets")))
#+end_src
** Appearance
*** Frame
#+begin_src emacs-lisp
;; Not decent enough, need to come up with a better way
(setq-default default-frame-alist
            (append (list
            '(internal-border-width . 20)
            '(left-fringe    . 0)
            '(right-fringe   . 0)
            '(tool-bar-lines . 0)
            '(menu-bar-lines . 0)
            '(vertical-scroll-bars . nil))))
#+end_src

*** Cursor
Enable ~x-stretch-cursor~ to identify spaces and tab
#+begin_src emacs-lisp
(setq x-stretch-cursor t)   ; Stretch cursor to the glyph width
#+end_src

** Binding

#+begin_src emacs-lisp
;; Leader prefixes
(map! :leader
     :desc "M-x"                  "SPC" #'execute-extended-command
     :desc "File file in project" "\\"  #'projectile-find-file)

;; Swap ';' and ":" in evil-motion-state-map
(map! (:after evil
       :m ";" 'evil-ex
       :m ":" 'evil-repeat-find-char))

(map! :map vertico-map
      "C-o" #'embark-act)
#+end_src
** Org
#+begin_src emacs-lisp :noweb no-export
(after! org;
  ; truncate lines
  (add-hook 'org-mode-hook (lambda () (setq truncate-lines nil)))

  ; Set tab width
  (add-hook 'org-mode-hook (lambda () (setq tab-width 2)))

  ; Set the default path for org-mode
  ; This way we can write relative path in org-capture
  (setq org-directory "~/org")

  ; Display images in-buffer by default
  (setq org-startup-with-inline-images t)
  (setq org-image-actual-width nil)

  ; Set correct color theme and tab in source block like in major mode
  (setq org-src-fontify-natively  t)
  (setq org-src-tab-acts-natively t)

  ;; Do not indent and keep any leading whitespace characters
  ;; It is recommended to edit source block with ~C-c '~
  ;; (setq org-edit-src-content-indentation 0)
  ;; (setq org-src-preserve-indentation   nil)

  ; Record a note when clocking out of an item.
  (setq org-log-note-clock-out t)


  (setq org-highest-priority ?A
        org-default-priority ?C
        org-lowest-priority ?E)

  <<org-tempo>>

  <<org-journal>>

  <<org-todo>>
  <<org-clock>>

  <<org-capture>>

  <<org-agenda>>
  )

#+end_src

#+RESULTS:

*** Org-todo
#+begin_src emacs-lisp :noweb-ref org-todo
;; Refer from: https://orgmode.org/list/8763vfa9hl.fsf@legolas.norang.ca/

(setq org-log-done 'note)
; Keywords to the left of the '|' are todo states
; Keywords to the right of the '|' are done (completed) states
; !: tells org-mode to record a date/time stamp
; @: tells org-mode to record a note and a date/time stamp
; For example:
; b!  : recording a date/time stamp when entering BUG state
; w@/!: recording a note and a date/time stamp when entering WAITING state,
;       and recording a date/time stamp when leaving WAITING state, too
(setq org-todo-keywords
  '((sequence "TODO(t)" "IN-PROGRESS(p!)" "NEXT(n@/!)" "|" "DONE(d@/!)")
      (sequence "WAITING(w@/!)" "|" "CANCELLED(c@!/!)")
      (sequence "ONGOING(o)" "|")
      (sequence "SOMEDAY(s/!)" "|")
      (sequence "|" "SUSPENDED(e@!/!)")
      (sequence "BUG(b!)" "KNOWNCAUSE(k)" "|" "FIXED(f!/!)")
      (sequence "DINE(n)" "CHAT(a)" "EMAIL(e)" "MEETING(m)" "|")))

;; (setq org-todo-keyword-faces
;;   '(("TODO"        . (:foreground "red" :weight bold))
;;     ("IN-PROGRESS" . (:foreground "orange" :weight bold))
;;     ("NEXT"        . (:foreground "IndianRed3" :weight bold))
;;     ("DONE"        . (:foreground "forest green" :weight bold))
;;     ("DONE"        . (:foreground "forest green" :weight bold))
;;     ("WAITING"     . (:foreground "orange" :weight bold))
;;     ("CANCELLED"   . (:foreground "forest green" :weight bold))
;;     ("SOMEDAY"     . (:foreground "orange" :weight bold))
;;     ("SUSPENDED"     . (:foreground "orange" :weight bold))
;;     ("BUG"         . (:foreground "red" :weight bold))
;;     ("KNOWNCAUSE"  . (:foreground "red" :weight bold))
;;     ("FIXED"       . (:foreground "forest green" :weight bold))
;;     ("ONGOING"     . (:foreground "orange" :weight bold))))

;; (setq colors
;;   '(("red"    . "#fb4934")
;;     ("green"  . "#b8bb26")
;;     ("yellow" . "#fabd2f")
;;     ("blue"   . "#83a598")
;;     ("purple" . "#d3869b")
;;     ("aqua"   . "#8ec07c")
;;     ("orange" . "#f38019")
;;     ("gray" .   "#928374")))

(setq org-todo-keyword-faces
  '(("TODO"        . (:foreground "#fb4934"    :weight bold))       ;; red
    ("IN-PROGRESS" . (:foreground "#f38019"    :weight bold))       ;; orange
    ("DOIN"        . (:foreground "#f38019"    :weight bold))       ;; orange
    ("NEXT"        . (:foreground "IndianRed3" :weight bold))       ;; Indian red
    ("DONE"        . (:foreground "#b8bb26"    :weight bold))       ;; green
    ("WAITING"     . (:foreground "#fabd2f"    :weight bold))       ;; yellow
    ("WAIT"        . (:foreground "#fabd2f"    :weight bold))       ;; yellow
    ("SOMEDAY"     . (:foreground "#fabd2f"    :weight bold))       ;; yellow
    ("CANCELLED"   . (:foreground "#928374"    :weight bold))       ;; gray
    ("SUSPENDED"   . (:foreground "#928374"    :weight bold))       ;; gray
    ("BUG"         . (:foreground "#fb4934"    :weight bold))       ;; red
    ("KNOWNCAUSE"  . (:foreground "#fb4934"    :weight bold))       ;; red
    ("FIXED"       . (:foreground "#b8bb26"    :weight bold))       ;; green
    ("ONGOING"     . (:foreground "#fabd2f"    :weight bold))))     ;; yellow
#+end_src

*** Org-agenda

#+begin_src emacs-lisp :noweb-ref org-agenda
;; (setq org-agenda-files '((concat org-directory "")
;;                         (concat org-directory "/school")))

(setq org-refile-targets '((nil :maxlevel . 3)
                           ("~/org/inbox.org" :maxlevel . 1)
                           ("~/org/agenda.org" :maxlevel . 1)
                           ("~/org/project.org" :maxlevel . 3)
                           ("~/org/todo.org" :maxlevel . 1)
                           ("~/org/tracker.org" :maxlevel . 3)
                           ("~/org/someday.org" :level . 1)))
(setq org-refile-use-outline-path 'file)
(setq org-outline-path-complete-in-steps nil)

;; Copy from https://emacs.stackexchange.com/a/10762
(defun org-refile-to-datetree (&optional file)
  "Refile a subtree to a datetree corresponding to it's timestamp.

The current time is used if the entry has no timestamp. If FILE
is nil, refile in the current file."
  (interactive "f")
  (let* ((datetree-date (or (org-entry-get nil "TIMESTAMP" t)
                            (org-read-date t nil "now")))
         (date (org-date-to-gregorian datetree-date))
         )
    (with-current-buffer (current-buffer)
      (save-excursion
        (org-cut-subtree)
        (if file (find-file file))
        (org-datetree-find-date-create date)
        (org-narrow-to-subtree)
        (show-subtree)
        (org-end-of-subtree t)
        (newline)
        (goto-char (point-max))
        (org-paste-subtree 4)
        (widen)
        ))
    )
  )

(general-define-key "C-c w" 'org-refile-to-datetree)



; Global agenda files
(setq org-agenda-files '("~/org/inbox.org"
                         "~/org/agenda.org"
                         "~/org/project.org"
                         "~/org/todo.org"
                         "~/org/tracker.org"
                         "~/org/someday.org"))

;; Press enter to go to the link
(setq org-return-follows-link t)

;; Always start on the current day.
(setq org-agenda-start-on-weekday nil)

;; Default only showing today's agenda
(setq org-agenda-span 'day)
(setq org-agenda-start-day "-0d")

;; Sorting strategy
(setq org-agenda-sorting-strategy '((agenda time-up category-up priority-down)
  (todo priority-down category-keep)
  (tags priority-down category-keep)
  (search category-keep)))

;; Enable log mode at start
(setq org-agenda-start-with-log-mode t)

;; How to create default clocktable
(setq org-clock-clocktable-default-properties
      '(:scope subtree :maxlevel 4 :timestamp t :link t :tags t :narrow 36!))

;; How to display default clock report in agenda view
(setq org-agenda-clockreport-parameter-plist
      '(:scope subtree :maxlevel 4 :timestamp t :link t :tags t :narrow 36!))

(setq org-columns-default-format
   "%40ITEM(Task) %TODO %3PRIORITY %13Effort(Estimated Effort){:} %CLOCKSUM %8TAGS(TAG)")


; Don't show scheduled items in agenda when they are in a DONE state.
(setq org-agenda-skip-scheduled-if-done t)
;;Don't show tasks as scheduled if they are already shown as a deadline
; (setq org-agenda-skip-scheduled-if-deadline-is-shown t)
; Restore layout after exit from agenda view
(setq org-agenda-restore-windows-after-quit t)

;; (setq org-agenda-todo-ignore-deadlines 'past)
;; (setq org-agenda-todo-ignore-scheduled 'past)

; Default showing warnings for deadlines 14 days in advance.
(setq org-deadline-warning-days 28)

; open agenda in current window and delete other windows
(setq-default org-agenda-window-setup 'only-window)

(setq org-agenda-prefix-format '((agenda . " %i %-12:c %-6:e %?-12t% s")
                                 (todo . " %i %-12:c %-6:e ")
                                 (tags . " %i %-12:c %-6:e ")
                                 (search . " %i %-12:c %-6:e ")))

(setq org-agenda-time-grid (quote ((daily today remove-watch)
                                   (800 1000 1200 1400 1600 1800 2000 2200 2400)
                                   "......"
                                   "-----------------------------------------------------"
                                   )))

; Define some custom agenda views
(defun place-agenda-tags ()
  "Put the agenda tags by the right border of the agenda window."
  (interactive)
  (setq org-agenda-tags-column (- 10 (window-width)))
  (org-agenda-align-tags))
(add-hook 'org-finalize-agenda-hook 'place-agenda-tags)

; Copy from https://www.labri.fr/perso/nrougier/GTD/index.html
(defun gtd-save-org-buffers ()
  "Save `org-agenda-files' buffers without user confirmation.
See also `org-save-all-org-buffers'"
  (interactive)
  (message "Saving org-agenda-files buffers...")
  (save-some-buffers t (lambda ()
             (when (member (buffer-file-name) org-agenda-files)
               t)))
  (message "Saving org-agenda-files buffers... done"))

;; Add it after refile
(advice-add 'org-refile :after
        (lambda (&rest _)
          (gtd-save-org-buffers)))

#+end_src
**** evil-org-agenda
???
**** org-super-agenda

#+begin_src emacs-lisp
(after! org-agenda
  (org-super-agenda-mode t))
#+end_src

#+begin_src emacs-lisp
(after! org-super-agenda
  (setq org-agenda-custom-commands
          '(("v" "Agenda day view"
            (
              (agenda ""
                (
                  (org-agenda-span 'day)
                  (org-deadline-warning-days 14)
                  (org-super-agenda-groups
                    '((:name "Today"
                            :time-grid t
                            ;; Aready set org-agenda-span to "day"
                            ;; :date today
                            :order 0)
                      (:name "Overdue" :deadline past :order 1)
                      (:name "Due Today" :deadline today :order 2)
                      (:name "Important"
                              :and (:priority "A" :not (:todo ("DONE" "CANCELED" "FIXED" "SUSPENDED")))
                              :order 3)
                      (:name "Due Soon" :deadline future :order 4)
                      (:name "Todo" :not (:habit t) :order 5)
                      (:name "Habits" :habit t :order 6))
                    )
                )
              )
              (alltodo ""
                (
                  (org-agenda-overriding-header "") ;; Don't insert default headers
                  (org-super-agenda-groups
                    '((:name "All todos" :and (:not(:todo "WAITING") :not (:habit t))) ; Filter out habits
                      (:name "Waiting" :todo "WAITING")
                      (:discard (:anything t))))
                )
              )
              (tags "CLOSED>=\"<today>\""
                (
                  (org-agenda-overriding-header "") ;; Don't insert default headers
                  (org-super-agenda-groups
                    '((:name "Completed Today" :anything t))
                      )
                )
              )
              (tags "CLOSED>=\"<-7d>\""
                (
                  (org-agenda-overriding-header "") ;; Don't insert default headers
                  (org-super-agenda-groups
                    '((:name "Completed this week" :anything t))
                      )
                )
              )
            )
            (
              (org-agenda-compact-blocks t)
              (org-agenda-files '("~/org/inbox.org"
                                  "~/org/todo.org"
                                  "~/org/agenda.org"))
            )
        )

          ("w" "Agenda week view"
            (
              (agenda ""
                (
                  (org-agenda-span 'week)
                  (org-agenda-skip-scheduled-if-done t)
                  (org-agenda-skip-function '(org-agenda-skip-entry-if 'todo 'done))
                  (org-deadline-warning-days 14)
                  (org-agenda-use-time-grid nil)
                  (org-habit-show-habits nil)
                  (org-super-agenda-groups
                    '((:name "Overdue" :deadline past :order 1)
                      (:name "Due Today" :deadline today :order 2)
                      (:name "Important"
                              :and (:priority "A" :not (:todo ("DONE" "CANCELED" "FIXED" "SUSPENDED")))
                              :order 3)
                      (:name "Due Soon" :deadline future :order 4)
                      (:name "Todo" :not (:habit t) :order 5))
                    )
                )
              )
            )
            (
              (org-agenda-compact-blocks t)
              (org-agenda-files '("~/org/inbox.org"
                                  "~/org/todo.org"
                                  "~/org/agenda.org"))
            )
        )
        ;; Match all headlines
        ("r" "Readings (org-super-agenda)" tags "*"
          (
            (org-agenda-files '("~/org/web/articles.org"
                                "~/org/web/books.org"
                                "~/org/web/videos.org"
                                "~/org/web/paper.org"))
            (org-agenda-overriding-header "") ;; Don't insert default headers
            (org-super-agenda-groups
              '(
                (:name "Reading" :todo "IN-PROGRESS" :order 0)
                (:name "To be read" :order 1 :not (:todo ("DONE" "CANCELED")))
                (:name "Done" :order 2 :todo ("DONE"))
                (:discard (:anything t))
                )
            )
          )
        )
        ("d" "Done tasks (org-super-agenda)" tags "/DONE|CANCELED"
          (
            (org-super-agenda-groups nil)
          )
        )
        ("o" "Someday (org-super-agenda)"
          (
            (alltodo "")
          )
          (
            (org-agenda-files '("~/org/someday.org"))
            (org-super-agenda-groups nil)
          )
        )
        ("D" "Upcoming deadlines (org-super-agenda)" agenda ""
          (
            (org-agenda-time-grid nil)
            (org-deadline-warning-days 365)
            (org-agenda-entry-types '(:deadline))
            (org-super-agenda-groups
              '((:name "Overdue" :deadline past :order 0)
                (:name "Due Today" :deadline today :order 1)
                (:name "Due Soon" :deadline future :order 2)
                ))
          )
        ))))

#+end_src

*** Org-habit
#+begin_src emacs-lisp
(after! org-habit
  (setq org-habit-graph-column 65)
  (setq org-habit-show-all-today nil)
  (setq org-habit-today-glyph ?.)
  (setq org-habit-completed-glyph ?v))
#+end_src
*** Org-capture
Here is a detailed article about org-capture: https://www.zmonster.me/2018/02/28/org-mode-capture.html
#+begin_src emacs-lisp :tangle no :noweb-ref org-capture
(general-define-key "C-c c" 'counsel-org-capture)

;; store new notes at the beginning of a file or entry.
(setq org-reverse-note-order t)

;; Empty templates
(setq org-capture-templates
        '(("i" "inbox" entry (file+headline "inbox.org" "Tasks")
	         "** TODO %^{Title} %^g \n:PROPERTIES:\n:Created: %U\n:END:\n%?")
          ("n" "note" entry (file+headline "inbox.org" "Notes")
	         "** %^{Title} %^g \n:PROPERTIES:\n:Created: %U\n:END:\n%?")

          ("a" "Agenda")
          ("ae" "event" entry (file+headline "agenda.org" "Event")
	         "** %^{Title} %^g \n%^T\n:PROPERTIES:\n:Created: %U\n:END:\n%?")
          ("ad" "dine" entry (file+headline "agenda.org" "Dine")
	         "** %^{Title} %^g \n%^T\n:PROPERTIES:\n:Created: %U\n:PEOPLE: %^{People}\n:LOCATION: %^{Location}\n:END:\n%?")
          ("am" "meeting" entry (file+headline "agenda.org" "Meeting")
	         "** %^{Title} %^g \n%^T\n:PROPERTIES:\n:Created: %U\n:PEOPLE: %^{People}\n:LOCATION: %^{Location}\n:END:\n%?")

          ; Web information
          ("r" "Read/Watch")
          ("ra" "article" entry (file "web/articles.org")
	         "** TODO %c %^g :article:\n:PROPERTIES:\n:Created: %U\n:END:\n%?")
          ("rb" "book" entry (file "web/books.org")
	         "** TODO %^{Title} %^g :book:\n:PROPERTIES:\n:Created: %U\n:END:\n%?")
          ("rp" "paper" entry (file "web/paper.org")
	         "** TODO %c %^g :research:\n:PROPERTIES:\n:Created: %U\n:END:\n%?")
          ("rv" "video" entry (file "web/videos.org")
	         "** TODO %c %^g :video:\n:PROPERTIES:\n:Created: %U\n:END:\n%?")

          ("t" "Tracker")
          ("td" "dine" entry (file+olp+datetree "tracker.org")
	         "** DINE %^{Title} %^g :dine:\n:PROPERTIES:\n:Created: %U\n:END:\n%?"
           :prepend t :tree-type week)
          ("tc" "chat" entry (file+olp+datetree "tracker.org")
	         "** CHAT %^{Title} %^g :chat:\n:PROPERTIES:\n:Created: %U\n:END:\n%?"
           :prepend t :tree-type week)
          ("te" "email" entry (file+olp+datetree "tracker.org")
	         "** EMAIL %^{Title} %^g :mail:\n:PROPERTIES:\n:Created: %U\n:END:\n- ref :: %a\n%?"
           :prepend t :tree-type week)
          ("tf" "chore" entry (file+olp+datetree "tracker.org")
	         "** IN-PROGRESS %^{Title} %^g :chore:\n:PROPERTIES:\n:Created: %U\n:END:\n- ref :: %a\n%?"
           :prepend t :tree-type week)
          ("ts" "sport" entry (file+olp+datetree "tracker.org")
	         "** IN-PROGRESS %^{Title} %^g :sport:\n:PROPERTIES:\n:Created: %U\n:END:\n- ref :: %a\n%?"
           :prepend t :tree-type week)
          ("ti" "interruption" entry (file+olp+datetree "tracker.org")
	         "** IN-PROGRESS %^{Title} %^g :interruption:\n:PROPERTIES:\n:Created: %U\n:END:\n- ref :: %a\n%?"
           :prepend t :tree-type week :clock-in t :clock-keep t)

          ;; for org-protcol firefox addon
          ("p" "org protocol" entry (file+headline "web/inbox.org" "Inbox")
              "* %^{Title}\nSource: %u, %c\n #+BEGIN_QUOTE\n%i\n#+END_QUOTE\n\n\n%?")
          ("L" "org protocol Link" entry (file+headline "web/inbox.org" "Inbox")
              "* %? [[%:link][%:description]] \nCaptured On: %U")))
#+end_src

*** Org-clock
#+begin_src emacs-lisp :noweb-ref org-clock
(setq org-clock-clocktable-default-properties '(:scope subtree :maxlevel 4 :timestamp t :link t :tags t :narrow 36!))

(defun cycatz/org-clock-report-with-tag ()
  (interactive)
  (insert "#+BEGIN: clocktable "
          (string-trim-right (string-trim-left (format "%s" org-clock-clocktable-default-properties) "(") ")")
          " :match \""
          (cycatz/counsel-org-tag-without-action)
          "\"\n#+END")
  (previous-line 1)
  (org-dblock-update))

;; Clock out when moving task to a done state
(setq org-clock-out-when-done t)
;; Change tasks to whatever when clocking in
(setq org-clock-in-switch-to-state "IN-PROGRESS")
;; use pretty things for the clocktable (this solves the misalignment issue when the title contains CJK characters)
(setq org-pretty-entities t)

;; save the clock history across Emacs sessions:
(setq org-clock-persist 'history)
(org-clock-persistence-insinuate)

;; I usually sleep before 04:00
(setq org-extend-today-until 4)
#+end_src
*** Org-tempo

#+begin_src emacs-lisp :noweb-ref org-tempo
;; Override the default config
(setq org-structure-template-alist
    '(("s" . "src")
     ("l" . "export latex\n")
     ("q" . "quote\n")))

(add-to-list 'org-modules 'org-tempo t)
(require 'org-tempo)
(add-to-list 'org-structure-template-alist '("sh" . "src sh"))
(add-to-list 'org-structure-template-alist '("sc" . "src scala"))
(add-to-list 'org-structure-template-alist '("bash" . "src bash"))
(add-to-list 'org-structure-template-alist '("fish" . "src fish"))
(add-to-list 'org-structure-template-alist '("asm" . "src asm"))
(add-to-list 'org-structure-template-alist '("py" . "src python"))
(add-to-list 'org-structure-template-alist '("yaml" . "src yaml"))
(add-to-list 'org-structure-template-alist '("json" . "src json"))

; templates for elisp source block
(add-to-list 'org-structure-template-alist '("el" . "src emacs-lisp"))
; templates for noweb reference syntax
(add-to-list 'org-structure-template-alist '("ei" . "src emacs-lisp :noweb no-export"))
(add-to-list 'org-structure-template-alist '("es" . "src emacs-lisp :tangle no :noweb-ref"))

; templates for C/C++ source block
(add-to-list 'org-structure-template-alist '("c"  . "src C"))
(add-to-list 'org-structure-template-alist '("cp" . "src cpp :includes <bits/stdc++.h> :namespaces std"))
#+end_src

#+begin_src emacs-lisp
(map! :after org
      :map org-mode-map
      :localleader
      "s" #'org-insert-structure-template)
#+end_src

*** Org-roam

#+begin_src emacs-lisp
(after! org-roam
  (setq org-roam-directory "~/org-roam")
  (setq org-roam-node-display-template (concat "${title:*} "
                                                  (propertize "${tags:30}" 'face 'org-tag))))
#+end_src

*** Org-journal
#+begin_src emacs-lisp :noweb-ref org-journal
(setq org-journal-dir "~/org/journal/"
      org-journal-date-format "%A, %d %B %Y")
#+end_src

#+begin_src emacs-lisp
(map! :after org
      :map doom-leader-note-map
      "jJ" #'org-journal-new-date-entry)
#+end_src

*** Org-beamer
**** Bindings
#+begin_src emacs-lisp
(map! :after org
      :map org-mode-map
      :localleader
      "jb" 'org-beamer-export-to-pdf)
#+end_src
*** Org-latex
**** Configs
The ~-shell-escape~ argument is for using ~minted~ package.
Without it, code highlighting will not work functionally.

#+begin_src emacs-lisp
(after! ox-latex
  (setq org-latex-pdf-process
        '("xelatex -shell-escape -interaction nonstopmode -output-directory %o %f"
          "xelatex -shell-escape -interaction nonstopmode -output-directory %o %f"
          "xelatex -shell-escape -interaction nonstopmode -output-directory %o %f"))
   (add-to-list 'org-latex-classes
                '("org-plain-latex"
                  "\\documentclass{article}
              [NO-DEFAULT-PACKAGES]
              [PACKAGES]
              [EXTRA]"
                  ("\\section{%s}" . "\\section*{%s}")
                  ("\\subsection{%s}" . "\\subsection*{%s}")
                  ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
                  ("\\paragraph{%s}" . "\\paragraph*{%s}")
                  ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))

  ; Beamer
  (add-to-list 'org-latex-classes
               '("beamer"
                 "\\documentclass[presentation]{beamer}
             [NO-DEFAULT-PACKAGES]
             [PACKAGES]
             [EXTRA]"
                 ("\\section{%s}" . "\\section*{%s}")
                 ("\\subsection{%s}" . "\\subsection*{%s}")
                 ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
                 ("\\paragraph{%s}" . "\\paragraph*{%s}")
                 ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))

   ; Cheatsheet
   (add-to-list 'org-latex-classes
                '("cheatsheet"
                  "\\documentclass{article}
              [NO-DEFAULT-PACKAGES]
              [PACKAGES]
              [EXTRA]"
                  ("\\section{%s}" . "\\section*{%s}")
                  ("\\subsection{%s}" . "\\subsection*{%s}")
                  ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
                  ("\\paragraph{%s}" . "\\paragraph*{%s}")
                  ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))
  ; ; Code highlighting
  (add-to-list 'org-latex-packages-alist '("" "minted"))
  (setq org-latex-listings 'minted)
  (setq org-latex-minted-options
        '(;;("frame" "lines")
          ("breaklines" "true")
          ("breakanywhere" "true")
          ("linenos" "")
          ("fontsize" "\\footnotesize")
          ("mathescape" "")
          ("samepage" "")
          ("xrightmargin" "0.5cm")
          ("xleftmargin"  "0.5cm")
          ))

  (setq org-export-in-background t)
  (setq org-latex-create-formula-image-program 'imagemagick)

  ; Clean up intermediate files after pdf is produced
  (setq org-latex-remove-logfiles t)
  (setq org-latex-logfiles-extensions (quote ("lof" "lot" "tex~" "aux" "idx" "log" "out" "toc" "nav" "snm" "vrb" "dvi" "fdb_latexmk" "blg" "brf" "fls" "entoc" "ps" "spl" "bbl")))

  ; You can also include your own package to insert custom code
  ; (add-to-list 'org-latex-packages-alist '("" "examplepackage"))
 )
#+end_src
**** Bindings
#+begin_src emacs-lisp
(map! :after org
      :map org-mode-map
      :localleader
      "je" 'org-latex-export-to-pdf)
#+end_src

*** Org-superstar
#+begin_src emacs-lisp
(after! org-superstar
  (setq org-superstar-headline-bullets-list '("◉" "○" "●" "◈" "◇")))
#+end_src

*** Org-download
#+begin_src emacs-lisp
(setq org-download-image-dir "~/photos/emacs")
;; Copy from org-download-screenshot-method customizations
(setq org-download-screenshot-method "flameshot gui --raw > %s")
#+end_src

**** Bindings
#+begin_src emacs-lisp
(map! :after org
      :map org-mode-map
      :localleader
      "js" 'org-download-screenshot
      "jc" 'org-download-clipboard)
#+end_src


*** Org-fancy-priorities
#+begin_src emacs-lisp
(after! org-fancy-priorities
  (setq org-fancy-priorities-list '("❗" "⚠️" "⚑" "⬆" "⬇" "■" "☕")))
#+end_src


*** Org/Company
#+begin_src emacs-lisp
(after! org
  (set-company-backend! 'org-mode
    'company-files 'company-tempo))
#+end_src


** Company
#+begin_src emacs-lisp
(after! company
  (setq company-tempo-expand t)
  ;; Excluded file and dirs in company-files backend
  (setq company-files-exclusions '(".git/" ".stversions/" ".stfolder/" ".DS_Store"))
  ; Make completions Case-sensitive
  (setq company-dabbrev-downcase nil))
#+end_src

** LSP

#+begin_src emacs-lisp
;; LSP
;; Clang
(setq lsp-clients-clangd-args '("-j=4"
                                "--background-index"
                                "--clang-tidy"
                                "--completion-style=detailed"
                                "--header-insertion=never"
                                "--header-insertion-decorators=0"))
(after! ccls
  (setq ccls-initialization-options '(:index (:comments 2) :completion (:detailedLabel t)))
  (set-lsp-priority! 'ccls 0))
(setq ccls-executable "/usr/bin/ccls")
;; (setq ccls-args '("--log-file=/tmp/ccls.log"))
#+end_src

*** C
#+begin_src emacs-lisp
(after! cc-mode
  (setq-hook! 'cc-mode-hook tab-width 4 c-basic-offset 4))
#+end_src

2022/12/17: Currently doesn't work, don't know why :(
#+begin_src emacs-lisp
(after! tramp
  (when (require 'lsp-mode nil t)

    (setq lsp-enable-snippet nil
          lsp-log-io nil
          ;; To bypass the "lsp--document-highlight fails if
          ;; textDocument/documentHighlight is not supported" error
          lsp-enable-symbol-highlighting nil)

    (lsp-register-client
     (make-lsp-client
      :new-connection
      (lsp-tramp-connection "/usr/bin/ccls")
       ; (lambda ()
       ;   (cons "clangd" ; executable name on remote machine 'ccls'
       ;         lsp-clients-clangd-args)))
      :major-modes '(c-mode c++-mode objc-mode cuda-mode)
      :remote? t
      :server-id 'ccls))))
#+end_src


* Snippets
** Copy Current file and Line Number
#+begin_src emacs-lisp
(defun cycatz/copy-current-line-position-to-clipboard ()
  "Copy current line in file to clipboard as '</path/to/file>:<line-number>'"
  (interactive)
  (let ((path-with-line-number
         (concat (buffer-file-name) ":" (number-to-string (line-number-at-pos)))))
    (kill-new path-with-line-number)
    (message (concat path-with-line-number " copied to clipboard"))))
(map!
  "M-c" 'cycatz/copy-current-line-position-to-clipboard)
#+end_src

** Splitting an Org block into two
#+begin_src emacs-lisp
   (defun modi/org-in-any-block-p ()
      "Return non-nil if the point is in any Org block.
The Org block can be *any*: src, example, verse, etc., even any
Org Special block.
This function is heavily adapted from `org-between-regexps-p'."
      (save-match-data
        (let ((pos (point))
              (case-fold-search t)
              (block-begin-re "^[[:blank:]]*#\\+begin_\\(?1:.+?\\)\\(?: .*\\)*$")
              (limit-up (save-excursion (outline-previous-heading)))
              (limit-down (save-excursion (outline-next-heading)))
              beg end)
          (save-excursion
            ;; Point is on a block when on BLOCK-BEGIN-RE or if
            ;; BLOCK-BEGIN-RE can be found before it...
            (and (or (org-in-regexp block-begin-re)
                     (re-search-backward block-begin-re limit-up :noerror))
                 (setq beg (match-beginning 0))
                 ;; ... and BLOCK-END-RE after it...
                 (let ((block-end-re (concat "^[[:blank:]]*#\\+end_"
                                             (match-string-no-properties 1)
                                             "\\( .*\\)*$")))
                   (goto-char (match-end 0))
                   (re-search-forward block-end-re limit-down :noerror))
                 (> (setq end (match-end 0)) pos)
                 ;; ... without another BLOCK-BEGIN-RE in-between.
                 (goto-char (match-beginning 0))
                 (not (re-search-backward block-begin-re (1+ beg) :noerror))
                 ;; Return value.
                 (cons beg end))))))

    (defun modi/org-split-block ()
;;   "Sensibly split the current Org block at point.
;; (1) Point in-between a line
;;     #+begin_src emacs-lisp             #+begin_src emacs-lisp
;;     (message▮ \"one\")                   (message \"one\")
;;     (message \"two\")          -->       #+end_src
;;                                        ▮
;;                                        #+begin_src emacs-lisp
;;                                        (message \"two\")
;;                                        #+end_src
;; (2) Point at EOL
;;     #+begin_src emacs-lisp             #+begin_src emacs-lisp
;;     (message \"one\")▮                   (message \"one\")
;;     (message \"two\")          -->       #+end_src
;;     #+end_src                          ▮
;;                                        #+begin_src emacs-lisp
;;                                        (message \"two\")
;;                                        #+end_src
;; (3) Point at BOL
;;     #+begin_src emacs-lisp             #+begin_src emacs-lisp
;;     (message \"one\")                    (message \"one\")
;;     ▮(message \"two\")          -->      #+end_src
;;     #+end_src                          ▮
;;                                        #+begin_src emacs-lisp
;;                                        (message \"two\")
;;                                        #+end_src
;; "
      (interactive)
      (if (modi/org-in-any-block-p)
          (save-match-data
            (save-restriction
              (widen)
              (let ((case-fold-search t)
                    (at-bol (bolp))
                    block-start
                    block-end)
                (save-excursion
                  (re-search-backward "^\\(?1:[[:blank:]]*#\\+begin_.+?\\)\\(?: .*\\)*$" nil nil 1)
                  (setq block-start (match-string-no-properties 0))
                  (setq block-end (replace-regexp-in-string
                                   "begin_" "end_" ;Replaces "begin_" with "end_", "BEGIN_" with "END_"
                                   (match-string-no-properties 1))))
                ;; Go to the end of current line, if not at the BOL
                (unless at-bol
                  (end-of-line 1))
                (insert (concat (if at-bol "" "\n")
                                block-end
                                "\n\n"
                                block-start
                                (if at-bol "\n" "")))
                ;; Go to the line before the inserted "#+begin_ .." line
                (beginning-of-line (if at-bol -1 0)))))
        (message "Point is not in an Org block")))

    (defun modi/org-meta-return (&optional arg)
      "Insert a new heading or wrap a region in a table.
Calls `org-insert-heading', `org-insert-item',
`org-table-wrap-region', or `modi/org-split-block' depending on
context.  When called with an argument, unconditionally call
`org-insert-heading'."
      (interactive "P")
      (org-check-before-invisible-edit 'insert)
      (or (run-hook-with-args-until-success 'org-metareturn-hook)
          (call-interactively (cond (arg #'org-insert-heading)
                                    ((org-at-table-p) #'org-table-wrap-region)
                                    ((org-in-item-p) #'org-insert-item)
                                    ((modi/org-in-any-block-p) #'modi/org-split-block)
                                    (t #'org-insert-heading)))))
    (advice-add 'org-meta-return :override #'modi/org-meta-return)
#+end_src

#+RESULTS:
